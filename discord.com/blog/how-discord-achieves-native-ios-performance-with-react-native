<!DOCTYPE html><!-- Last Published: Mon Nov 21 2022 18:35:28 GMT+0000 (Coordinated Universal Time) --><html data-wf-domain="discordpages.webflow.io" data-wf-page="6102fadda3eb27bb56da0f57" data-wf-site="5f8dd67f8fdd6f51f0b50904"><head><meta charset="utf-8"/><title>How Discord achieves native iOS performance with React Native</title><meta content="" name="description"/><meta content="How Discord achieves native iOS performance with React Native" property="og:title"/><meta content="" property="og:description"/><meta content="https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/611ed88188db6c4aeb477a51_1_Xrs64ioQm2DcmH9Si-M3pw.png" property="og:image"/><meta content="How Discord achieves native iOS performance with React Native" property="twitter:title"/><meta content="" property="twitter:description"/><meta content="https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/611ed88188db6c4aeb477a51_1_Xrs64ioQm2DcmH9Si-M3pw.png" property="twitter:image"/><meta property="og:type" content="website"/><meta content="summary_large_image" name="twitter:card"/><meta content="width=device-width, initial-scale=1" name="viewport"/><link href="https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/css/discordpages.ece25cbbf.css" rel="stylesheet" type="text/css"/><!--[if lt IE 9]><script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js" type="text/javascript"></script><![endif]--><script type="text/javascript">!function(o,c){var n=c.documentElement,t=" w-mod-";n.className+=t+"js",("ontouchstart"in o||o.DocumentTouch&&c instanceof DocumentTouch)&&(n.className+=t+"touch")}(window,document);</script><link href="https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/60ae916347747e71167e21cc_favicon.png" rel="shortcut icon" type="image/x-icon"/><link href="https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/5f91fae62cc821206588b837_Frame%20246.png" rel="apple-touch-icon"/><link href="rss.xml" rel="alternate" title="RSS Feed" type="application/rss+xml"/><!-- Localize integration code -->
<script src="https://global.localizecdn.com/localize.js"></script>
<script src="../webflow-scripts/head.js"></script>
<style>
  .nav-bar-hack {
  	bottom: 0px !important;
    height: auto !important;
  }
  
  body a.w-webflow-badge {
    display: none !important;
  }
  
  body {
  	text-rendering: optimizeLegibility;
  }
  
  @media screen and (max-width: 476px) {
    .hide-on-mobile {
      display: none;
    }
  }
  
  .hr-style {
  border: 0;
  height: 8px;
  background-color: #F0F0F0;
  margin: 20px 0px;
  }
  
  .BlogBodyQuote {
  grid-column: 2/-1;
  font-size: 24px;
  line-height: 36px;
  padding: 0px 0px 15px 40px;
  font-style: italic;
  margin: 40px 0px 50px 0px;
}

.quote-text {
  width: 100%;
  margin-top: 10px;
}

.quote-icon {
  position: relative;
  top: 16px;
}

footer.quote-footer {
  font-size: 16px;
  margin-top: 20px;
  font-style: normal;
}
</style>

<style>
.language{
    display:flex;
    user-select: none;
}
.language .lang-container {
    position: relative;
}

.language .lang-selector-container {
    display: flex;
    align-items: center;
    cursor: pointer;
}

.language .locale-container{
    display: flex;
    align-items: center;
}

.language .flag {
    width: 24px;
    height: 16px;
    margin-right: 8px;
}

.language .selector-language-name{
    color: #fff;
    font-size: 14px;
    line-height: 18px;
}

.language .arrow-icon{
    padding-left: 8px;
}

.language .lang-dropdown-container {
    z-index: 10;
    bottom: 100%;
    margin-bottom: 8px;
    position: absolute;
    background-color: #fff;
    border-radius: 8px;
    box-shadow: 0 1px 1px rgb(0 0 0 / 10%);
    overflow: hidden;
    display: none;
}

.language .lang-dropdown {
    max-height: 320px;
    min-width: 150px;
    overflow-x: hidden;
    overflow-y: auto;
    overscroll-behavior: contain;
}

.language .dropdown-item{
    padding: 8px;
}

.language .dropdown-clickable{
    cursor: pointer;
}

.language .dropdown-language-name{
    color: #23272a;
    font-size: 14px;
    line-height: 18px;
}

.flag-ru{
    content:url(https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb4da57001e8f59b8a77_62cb46f39e6ac4c46ce39566_ru.png);
}

.flag-bg{
    content:url(https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cdbc0dc0fb5f55e3098f_6257c2a1e7544e303083b2b1_bolg.png);
}
.flag-cs{
    content:url(https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb4c83827a1284afe239_62cb46f1254305732a01676d_cs.png);
}
.flag-da{
    content:url(https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb4ad6ee377e0df4cde6_62cb46f16128094022db6768_da.png);
}
.flag-de{
    content:url(https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb4aa35fe71fedf5e95f_62cb46f1c50496ce73c40d99_de.png);
}
.flag-en-GB {
    content:url("https://assets-global.website-files.com/6257adef93867e50d84d30e2/62d01c2078d11b68a1633276_Rectangle%201%20(3).svg");
}
.flag-el{
    content:url(https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb4ca5700115ec9b8a67_62cb46f17c26b5fe5a53876f_el.png);
}
.flag-en-US{
    content:url(https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cdbc488f5f603e7ecd2a_6257bf8b5ba300233705a542_en.png);
}
.flag-en{
    content:url(https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cdbc488f5f603e7ecd2a_6257bf8b5ba300233705a542_en.png);
}
.flag-es{
    content:url(https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb4b7670687b935aaed4_62cb46f14edab1b0029593fc_es-ES.png);
}
.flag-fi{
    content:url(https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb48951dec0cce94a2b1_62cb46f1921c0cf82fc59da7_fi.png);
}
.flag-fr{
    content:url(https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb4a01339d451d474860_62cb46f1544a7ab7c66e9ccb_fr.png);
}
.flag-hi{
    content:url(https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb47b3070262fdccd2a6_62cb46f13fcb6e76c05b504e_hi.png);
}
.flag-hr{
    content:url(https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb4764813ee14c33c45f_62cb46f1aeebe9064763c90c_hr.png);
}
.flag-hu{
    content:url(https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb486b18c7334c564b9a_62cb46f19e6ac41dcce39561_hu.png);
}
.flag-it{
    content:url(https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb47fcf6b11ce186dd29_62cb46f1bd099a25f8f77ea4_it.png);
}
.flag-ja{
    content:url(https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb49fa4234bc13a595aa_62cb46f1e819841940bec47d_ja.png);
}
.flag-ko{
    content:url(https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb4b6b18c7266d564ba3_62cb46f125430509b9016776_ko.png);
}
.flag-lt{
    content:url(https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb4bc5fa8c17a80ae4c4_62cb46f14edab152b8959405_lt.png);
}
.flag-nl{
    content:url(https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb4d6b18c71a53564bac_62cb46f3e00ff80959abff2a_nl.png);
}
.flag-no{
    content:url(https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb4d29670fb8a9998a06_62cb46f37c26b5e22453877d_no.png);
}
.flag-pl{
    content:url(https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb4fd9e48ce2224e71b3_62cb46f3c504963019c40db7_pl.png);
}
.flag-pt-BR{
    content:url(https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb4d41e0514ceaeb0814_62cb46f3d809bc2503e62bec_pt-BR.png);
}
.flag-ro{
    content:url(https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb4b7b2666d9520e434e_62cb46f36e94d725ce411ab6_ro.png);
}
.flag-sv{
    content:url(https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb5036a202f7044eb402_62cb46f49e6ac47674e39567_sv-SE.png);
}
.flag-th{
    content:url(https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb502ab71d0c254b8e0c_62cb46f465c529bf26e211a1_th.png);
}
.flag-tr{
    content:url(https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb4f41e0515a89eb082a_62cb46f4e819848178bec4d1_tr.png);
}
.flag-uk{
    content:url(https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb4f36a20273d04eb401_62cb46f37c26b54f6a53877f_uk.png);
}
.flag-vi{
    content:url(https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb4f00801f3750f4834e_62cb46f4e819840d89bec4d2_vi.png);
}
.flag-zh-Hans{
    content:url(https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb5010e73af938ef607e_62cb46f49e6ac45f35e39568_zh-CN.png);
}
.flag-zh-TW{
    content:url(https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6321cb4fd354ea61ac8db41c_62cb46f33fcb6ea5c95b5069_zh-TW.png);
}
</style>

<style>
.btn-wrapper a {
  color: #fff ;
}
</style></head><body class="dont-translate"><div style="background-color:hsla(205.7142857142857, 9.09%, 15.10%, 1.00)" class="header-blue-blog wf-section"><div class="blog-navbar"><a href="discord-activities-play-games-and-watch-together" class="blog-brand-copy w-nav-brand"><img src="https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/613b8fc3834b2bd42157bc04_blogwhite.svg" loading="lazy" alt="Discord"/></a><div data-collapse="medium" data-animation="over-right" data-duration="400" data-easing="ease" data-easing2="ease" role="banner" class="navbar-5 w-nav"><div class="container-790 w-container"><nav role="navigation" class="blog-nav w-nav-menu"><div data-delay="100" data-hover="true" class="w-dropdown"><div class="w-dropdown-toggle"><img src="https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/635157e8f94a8580bcbb3e32_Shape.svg" loading="lazy" alt="" class="icon mobile"/><img src="https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/614275ac3d35134cb2a96b63_down.svg" loading="lazy" alt="" class="icon white"/><div class="blog-nav-item">COLLECTIONS</div></div><nav class="dropdown-list w-dropdown-list"><div class="w-dyn-list"><div role="list" class="w-dyn-items"><div role="listitem" class="w-dyn-item"><a href="../category/community" class="dropdown-link w-dropdown-link">Community</a></div><div role="listitem" class="w-dyn-item"><a href="../category/company" class="dropdown-link w-dropdown-link">Discord HQ</a></div><div role="listitem" class="w-dyn-item"><a href="../category/engineering" class="dropdown-link w-dropdown-link">Engineering &amp; Design</a></div><div role="listitem" class="w-dyn-item"><a href="../category/how-to-discord" class="dropdown-link w-dropdown-link">How to Discord</a></div><div role="listitem" class="w-dyn-item"><a href="../category/safety" class="dropdown-link w-dropdown-link">Policy &amp; Safety</a></div><div role="listitem" class="w-dyn-item"><a href="../category/product" class="dropdown-link w-dropdown-link">Product &amp; Features</a></div></div></div></nav></div><a href="../blog-featured" class="blog-nav-item w-nav-link">Featured</a><a href="https://discord.com/" class="blog-nav-item w-nav-link">Discord.com</a><div class="w-embed"><form action="https://discord.com/blog/search" class="form-search w-form" style="display: flex"><input type="search" class="text-field w-input" maxlength="256" name="query" placeholder="Search…" id="search" required=""><input type="submit" value="" class="btn-search w-button"></form></div><form action="https://discord.com/search" class="form-search w-form"><input type="search" class="text-field w-input" maxlength="256" name="query" placeholder="Search…" id="search" required=""/><input type="submit" value="" class="btn-search w-button"/></form></nav><div class="w-nav-button"><img src="https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/60b6ad79b75c18f025626c71_menuicon.svg" loading="lazy" alt="Menu" class="image-14"/></div></div></div></div></div><div style="background-color:hsla(205.7142857142857, 9.09%, 15.10%, 1.00)" class="blog-home-hero-header wf-section"></div><div class="blog-featured-section wf-section"><div class="blog-hero-container hero-offset w-dyn-list"><div role="list" class="collection-list w-dyn-items"><div role="listitem" class="collection-item-4 w-dyn-item"><div class="div-block-15"><img src="https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/611ed88188db6c4aeb477a51_1_Xrs64ioQm2DcmH9Si-M3pw.png" loading="lazy" alt="" sizes="(max-width: 479px) 92vw, (max-width: 767px) 95vw, (max-width: 991px) 92vw, (max-width: 1919px) 91vw, 1368px" srcset="https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/611ed88188db6c4aeb477a51_1_Xrs64ioQm2DcmH9Si-M3pw-p-500.png 500w, https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/611ed88188db6c4aeb477a51_1_Xrs64ioQm2DcmH9Si-M3pw-p-800.png 800w, https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/611ed88188db6c4aeb477a51_1_Xrs64ioQm2DcmH9Si-M3pw-p-1080.png 1080w, https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/611ed88188db6c4aeb477a51_1_Xrs64ioQm2DcmH9Si-M3pw-p-1600.png 1600w, https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/611ed88188db6c4aeb477a51_1_Xrs64ioQm2DcmH9Si-M3pw.png 2000w" class="image-19"/></div><div class="blog-hero-heading-section"><a href="../category/engineering" class="blog-hero-category">Engineering &amp; Design</a><a href="how-discord-achieves-native-ios-performance-with-react-native" aria-current="page" class="blog-hero-heading w--current">How Discord achieves native iOS performance with React Native</a></div></div></div></div></div><div class="blog-post-container wf-section"><div class="column-wrapper w-row"><div class="column-3 w-col w-col-2 w-col-stack"><div class="the-author-section"><img src="https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/6126ba0b348c620c22bebbd6_1_DPozN5ReL1X-5eV6A5IsPQ.jpg" loading="lazy" width="72" alt="" class="image-22"/><div><div class="blog-post-author">Miguel Gaeta</div><div class="blog-post-author-name">November 7, 2019</div></div></div><div class="tag-section w-condition-invisible"><div class="divider-bar-copy"></div><div class="tags-sections-head">Tags</div><div class="collection-list-wrapper-2 w-dyn-list"><div class="empty-state w-dyn-empty"></div></div></div></div><div class="column-4 w-col w-col-8 w-col-stack"><div id="heading-1" class="rich-wrapper"><div class="blog-post-content w-richtext"><p>Early on at Discord, we adopted React Native <a href="https://blog.discordapp.com/using-react-native-one-year-later-91fd5e949933" target="_blank">as soon as it was open sourced</a> to build our iOS app from the core of our React app. Years later, we are still happy with that decision. Our <a href="https://apps.apple.com/us/app/discord/id985746746" target="_blank">iOS app</a> currently sees many millions of monthly active users, is 99.9% crash free, and holds a 4.8 star rating on the app store. <a href="https://facebook.github.io/react-native/" target="_blank">React Native</a> has been instrumental in allowing us to achieve this with a team of only three core iOS engineers!</p><p>The ergonomic benefits of using it as our foundation <a href="https://blog.discordapp.com/why-discord-is-sticking-with-react-native-ccc34be0d427" target="_blank">have remained compelling</a> as time has passed. Features are greatly simplified due to the extensive amount of code sharing we leverage. Furthermore, engineers who primarily work on the Discord web app in React can easily jump into the iOS codebase and be productive — even building and owning entire vertical slices.</p><p>However, towards the beginning of the year we started to notice that the app had appeared to have degraded across several vectors (frame drops, battery drain, time to interaction, etc) and it was unclear why. When we originally built the app in 2015 it performed quite well on an iPhone 5s, which served as our baseline model. Now in 2019, the app was nearly un-usable on the four year old iPhone 6s. What happened? Even when using a top end iPhone XS, the app could not maintain 60 FPS in normal usage, provide smooth gestures, and had a noticeable impact on battery life.</p><p>We knew that our app was once fast, and we wanted to more deeply understand if the problems we were seeing could be tackled on our end, or if the issue was more deeply rooted in React Native itself. With this in mind, we created a mobile performance squad, whose mission was to execute a deep dive into driving top tier performance on across all supported iOS devices. We would like to share what we have learned!</p><h1>Phase 1: Flux Store Optimizations</h1><p>Our first idea was to investigate our <a href="https://redux.js.org/basics/data-flow" target="_blank">data flow</a> (Discord pre-dates <a href="https://redux.js.org/" target="_blank">Redux</a>, but our architecture is similar) for potential performance bottlenecks. We had many stores running many actions and believed some expensive dispatches could have been the cause of the problem. We started by adding some basic logging that showed time spent processing each of our <a href="https://reactjs.org/blog/2014/07/30/flux-actions-and-the-dispatcher.html" target="_blank">dispatch actions</a> across stores. Next we limited our logging to only show <strong>dispatches that took longer than 10ms</strong> and immediately saw some points of interest.</p><ul role="list"><li>Every action that triggered an update to our user <a href="https://redux.js.org/api/store" target="_blank">store</a> — which holds the state of all known users — resulted in a <strong>30ms</strong> emit.</li><li>Our message load/cache restore actions — which directly result in processing and rendering our chat messages — resulted in a <strong>500ms </strong>on an iPhone XS and <strong>1000ms</strong> on iPhone 6s!</li></ul><p>While neither of these actions were directly causing stutter or frame drops, they were clearly wasting a lot of CPU and battery.</p><h3>User actions</h3><p>By using the <a href="https://developers.google.com/web/tools/chrome-devtools/rendering-tools/" target="_blank">Chrome profiler</a> we realized that one of our top level components was listening to the user store updates. This was problematic since as it was top level, it rendered many children (of which many were not <a href="https://reactjs.org/docs/react-api.html#reactpurecomponent" target="_blank">pure</a>). On a very active account, these costly actions and subsequent renders were happening every second.</p><p>By removing the dependency from the top level component and instead re-working it so that our child components that more directly required the users listened to it instead, we <strong>shaved 30ms </strong>from those dispatches. Nice!</p><h3>Message actions</h3><p>Meanwhile, the message load/cache actions were initially baffling because they were optimized before and known to be fast in React. Surely if they were this slow, our desktop user’s would have noticed. We switched to the profiler, and unfortunately found that the actions <em>were only taking 20ms</em><strong><em> </em></strong><em>in Chrome</em>, which is not what we were seeing in the simulator/device.</p><p>What we were dealing with was a difference between <a href="https://v8.dev/" target="_blank">V8</a> and <a href="https://webkit.org/" target="_blank">JSC</a>, which we learned by switching back to basic logging to directly observe the impact on a device. After wrapping the components listening to these actions in some timings, it revealed that the bottleneck was in our <strong>markdown parsing</strong>.</p><p>We found that a big cost factor was our escape rule, which was inline compiling a massive regular expression. The fix was easy since the regular expression could have been a constant (<em>never compile regex&#x27;s inline in a tight loop!</em>). This was great because it <strong>cut the cost down by 30%</strong> and now we were at <strong>350ms on iPhone XS and 700ms on iPhone 6S</strong>. That is a 15-30FPS gain on loading messages, and directly translated to reduction in <a href="https://developers.google.com/web/tools/lighthouse/audits/time-to-interactive" target="_blank">TTI</a> — for us this means being able to navigate the UI!</p><p>Unfortunately, we were still left with an unacceptable amount of time being spent parsing messages. After further digging we realized that running our Unicode emoji detection was extremely expensive on JSC but basically free on V8. We were — for the last four years — concatenating hundreds of Unicode symbols into a single regular expression which apparently is not a good idea. Luckily, <a href="https://medium.com/reactnative/emojis-in-javascript-f693d0eb79fb" target="_blank">someone brave</a> had created a good Unicode emoji range regex that we could use instead. This removed nearly all the remaining cost! We were down to <strong>30ms on iPhone XS and 90ms on an iPhone 6S</strong>. That was a 90% reduction from where we started, shaved nearly a second from TTI, and generally reduced CPU and battery usage significantly!</p><p>This phase netted a lot of big and easy wins! Unfortunately, while all actions were now under a few milliseconds, and the app ran better, our goals were not yet reached. Basic logging was no longer giving actionable information, which meant any remaining CPU cost was coming from <a href="https://twitter.com/dan_abramov/status/981712092611989509" target="_blank">React’s commits</a> which run on separate ticks. It was time to figure out how to determine the cost of our component hierarchy.</p><h1>Phase 2: React Component Optimizations</h1><p>At first we tried to use the Chrome profiler again since React 16+ snapshots its commits in the profiler. However, it records way more than just React. We were also not interested in the cost on V8 since we were trying to improve performance on JSC. Luckily, both of these could be solved since late last year the React team released a <a href="https://reactjs.org/blog/2018/09/10/introducing-the-react-profiler.html" target="_blank">React Profiler</a> that focuses on render time, great!</p><p>So we fired up the profiler, hit refresh, and then clicked around. A few things quickly jumped out:</p><ul role="list"><li>Our React commits could cost up to <strong>200ms </strong>when affecting things at the higher levels of the component tree. On top of this, we were going through up to three commit passes when the app was starting up.</li><li>When viewing the direct message list, we were looping over the whole list on every render to do sorting (some power user’s could have up to 1500 channels).</li><li>We had a lot of common views like &lt;Icon&gt; constantly re-rendering despite having no changes in props or state. While these were cheap to render, they added up.</li><li><a href="https://facebook.github.io/react-native/docs/flatlist.html" target="_blank">FlatList</a> and <a href="https://facebook.github.io/react-native/docs/sectionlist" target="_blank">SectionList</a>, which powered all of our lists, are very expensive and their virtualization is<a href="https://github.com/facebook/react-native/issues/13413" target="_blank"> not yet fully optimized</a>. In large servers, for our channel and member lists, they ended up slowly allocating thousands of views which become slow to unmount. Updating our channel list could cost up to <strong>100ms</strong>.</li></ul><p>Jackpot! There were a lot of actionable items, but not as trivial as the Flux store performance pass.</p><h3>Commit Passes</h3><p>Fixing the three commit passes was surprisingly simple. When React Native was released, there was no easy way to get the current dimensions of the screen so we relied on the very first render to trigger an onLayout which we sent to a ScreenStore for others to consume. Luckily, React Native has since improved the <a href="https://facebook.github.io/react-native/docs/dimensions.html" target="_blank">Dimensions</a> module by giving it more information and firing events when they change. We made a change so that our stores could initialize with the correct data, avoiding multiple commit passes and even shrinking the view hierarchy. This actually shaved about <strong>150ms off TTI </strong>since diffing the tree at the top level was not cheap.</p><h3>Direct Message Rendering</h3><p>Fixing the frequent looping over the whole channel list on render was also very trivial, and almost felt silly that we hadn’t fixed this code years ago. We already had a store that maintained a sorted list of the user’s direct messages. This drop in replacement shaved about <strong>2ms</strong> per render, but if you were viewing direct messages with a long list of many active users, this would happen quite frequently.</p><h3>Pure Component</h3><p>A lot of engineers at Discord used to default to using <a href="https://reactjs.org/docs/react-api.html#reactpurecomponent" target="_blank">PureComponent</a> since it avoids renders if props don&#x27;t change. Unfortunately, it isn&#x27;t that simple.</p><p>When creating a component, one should consider how it will be used and if the props will rarely change, or if the component should just be a pass though and give the rendering decision to its children.</p><p>Another thing not always clear to our engineers, was that style and children are just like any other prop and if you are passing a style as an array or dynamically creating style objects, you are breaking PureComponent, the same goes for children. Unless explicitly controlled, any children are just creating new components which never pass an equality check.</p><p>With the above in mind we did a pass over our most commonly used Component’s — removing unnecessary instances of Pure and minimizing our use of dynamic styles. All of this work resulted in about <strong>30ms</strong> being shaved from rendering when doing common actions like switching channels.</p><h3>Fast List</h3><p>Lists have always been a headache in React Native. We’ve actually implemented our core chat view natively because lists don’t perform well for many dynamic rows. We always hoped and assumed that React Native lists were good enough for simpler use cases like our channel and member lists. Unfortunately, despite the React Native team <a href="https://facebook.github.io/react-native/blog/2017/03/13/better-list-views" target="_blank">rewriting lists</a> and promising better performance, memory usage and virtualization of the built-in FlatList and SectionList did not meet our expectations.</p><p>One of the reasons that built-in lists have performance challenges is because they support a lot of features, and do aggressive pre-rendering as a solution to combat the fact that the underlying &lt;ScrollView&gt; renders in the main thread and JavaScript has to feed it more content as you scroll. What this means is after a &lt;FlatList&gt; mounts, it eventually renders all its rows slowly every frame. Using the <a href="https://facebook.github.io/react-native/docs/debugging#performance-monitor" target="_blank">Perf Monitor</a>, it could be seen that when looking at large Discord servers, they mounted nearly 2000 views.</p><p>Since this is a known pain point in the React Native community, there are already solutions to this problem. We spent some time first testing out <a href="https://github.com/bolan9999/react-native-largelist" target="_blank">react-native-large-list</a> which was immediately a significant improvement, brought down rendering down to <strong>60ms</strong>, and only ever rendered about 400 views in large Discord servers. It was not the best to work with because it required restructuring our data that was already computed for both iOS and Desktop in stores, but it was a trade off that we could deal with. Unfortunately, when using the library for much larger lists (eg: 100,000 rows) like channel members, it would lock up the CPU.</p><figure class="w-richtext-align-center"><div><img src="https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/611ed8ad01395d302cfe2737_1*aGWZttnhsIgBJYh5WCsxZQ.gif" alt=""/></div><figcaption><em>Dramatic representation of a recycler view with a pool of reuse-able views.</em></figcaption></figure><p>Next we found <a href="https://github.com/Flipkart/recyclerlistview" target="_blank">recyclerlistview</a> which actually worked even better! It had similar results in the amount of views it mounted, and it was able to keep 60 FPS fill rate on scroll. What was better was that it brought down rendering to <strong>30ms</strong> for server switching, and channel switching down to <strong>10ms</strong>! Unfortunately, despite trying to trick it via many methods, it suffered from one frame blanks on mount, weird scroll positions when trying to scroll to an item on mount, and the sticky headers implementation conflicted with <a href="https://facebook.github.io/react-native/docs/animated" target="_blank">Animated</a>.</p><p>At this point, we were out of open source solutions. So we either had to settle on recyclerlistview or come up with our own solution.</p><p>At first, we felt that maybe doing it purely in JavaScript was futile. We spent some time trying to glue together <a href="https://developer.apple.com/documentation/uikit/uitableview" target="_blank">UITableView</a> with React Native, and while we made meaningful progress, it started feeling overly complicated. After stepping back and thinking about what else we could do — it hit us. We already solved this problem once before on the web! We already had an internal List component that virtualizes its children. There is no way we could just drop it into React Native right?</p><p>We replaced &lt;Scroller&gt; with &lt;ScrollerView&gt; and &lt;div&gt; with &lt;View&gt; and dropped it in. It worked! Right out of the box it performed almost as well as recyclerlistview and was able to use nearly the same code for rendering as the desktop app. We then spent some additional time adding sticky header support and using some similar techniques employed by recyclerlistview to recycle views - avoiding allocations both on the React and UIKit side.</p><p>Before and using our new &lt;FastList&gt; component on an iPhone 6s and <a href="https://vimeo.com/371488359" target="_blank">an iPhone XS </a>— this yielded significantly less blanking and stuttering on large lists:</p><p>‍</p><figure style="padding-bottom:52.173913043478265%" class="w-richtext-align-center w-richtext-figure-type-video"><div><iframe allowfullscreen="true" frameborder="0" scrolling="no" src="https://player.vimeo.com/video/371264735"></iframe></div></figure><p>The result was a new component we called &lt;FastList&gt;. The team intends to merge these together for cross-platform use and open source it for the community. With that we removed a lot of memory allocations and were down another <strong>70-90ms</strong> of render time. We could now scroll the channel members list as fast as we wanted and it kept up admirably.</p><p>This phase took a lot more work since it required writing some new libraries. It net resulted in over <strong>100ms</strong> render time savings in common app usage patterns. The app was now performing great during active usage!</p><h1>Phase 3: Main Thread Optimizations</h1><p>So now that Flux stores were performing well, and components were not spending a lot of time rendering — there remained a few big mysteries:</p><ul role="list"><li>When opening the emoji picker for the first time, <em>the UI froze for up to 2s on an iPhone XS</em> and this didn’t show up anywhere in JavaScript profiling.</li><li>When coming back from backgrounding the app, switching between a direct message and server for first time <em>froze the UI for up to 2s on an iPhone XS</em>.</li></ul><p>If that was all happening just after an initial boot it could have been explained away with resources needing to be loaded into memory, but it was also happening after backgrounding… what could it be?</p><h3>Emoji Picker</h3><p>We suspected the emoji picker itself was the source of the UI lockup, but we knew that if it was something purely related to resource loading we only would have seen the issue once per app boot.</p><p>So we started adding logging to every ancestor component of our emoji picker and found that our chat input component was remounting when switching between private messages and servers! Oddly, the remount didn&#x27;t seem expensive after the first time it remounted. More importantly, these components were never supposed to remount by design, so why were they? It turns out they were wrapped in a different root component depending on context, and changing a component type in the tree is just like <a href="https://medium.com/@albertogasparin/forcing-state-reset-on-a-react-component-by-using-the-key-prop-14b36cd7448e" target="_blank"><em>setting a different key</em></a>. Merging the two components <strong>reduced the 2s lockup down to 500ms</strong>, which was a win but not yet fast enough.</p><h3>Image Loading</h3><p>While the component was now loading much faster, there was still the mystery of why is still remained relatively slow. What was even weirder is we could not reproduce this on a development build and only on a production build. What was different between the two? One thing we saw was that all app bundled images were loaded via development servers in dev mode but stored in memory caches for production.</p><p>Before diving deeper we tried a simple test. We deleted all the images from disk and launched the app. It was fast, which meant indeed something about the image loading was the root cause. So we took console.log&#x27;s long lost cousin NSLog and decorated all the local file loading code for RCTImage with call times. RCTImage loads all local files out of bound using [UIImage imageNamed] on the main thread to avoid flickering. Unfortunately, those calls were taking <strong>50ms</strong> each for every call after launching the app or after backgrounding!</p><p>[UIImage imageNamed] is the de-facto method for loading images on iOS, so, why was it slow? It turns out, React Native was passing it absolute paths instead of referencing named images in the bundle. So, we deleted all the images again and added a few of them to the bundle and tried again. Now, the exact same images were loading in <strong>0.1ms</strong> and the app was fast. Unfortunately, this method means we would have to explicitly add all images to an Xcode project and we can&#x27;t over the air deploy them.</p><p>So we tried another crazy thing. RCTImage has a fallback to read bytes from disk and pass them into UIImage if [UIImage imageNamed] for some reason does not work. So we commented out the [UIImage imageNamed] calls and let it fall through. To our surprise, without any caching, constantly reading these images from disk and decoding them was only taking <strong>0.3ms</strong>! We were shocked by the result and this could only mean there is some kind of bug in <a href="https://developer.apple.com/documentation/uikit" target="_blank">UIKit</a> when handling memory cache misses for files that actually exist on disk.</p><p>Luckily, React Native allows you to create custom image loaders. So we created a <a href="https://facebook.github.io/react-native/docs/native-modules-ios" target="_blank">native module</a> LocalAssetImageLoader which reads files directly from disk, decodes them, and manages its own memory cache. This bypassed the bottle-neck we were seeing and gave us blazing fast image loading.</p><h3>Battery Heat</h3><p>Finally, we were still noticing that using Discor<a href="http://watchanimeattheoffice.com" target="_blank">d</a> for a bit — even lightly — could result in the battery heating up. While looking at our idle CPU usage we noticed our JavaScript thread was now mostly idle now at 0–5% CPU of 1 core (down from up to 30%), but for whatever reason the main UI thread would sit at 10% CPU when looking at a Discord server. After slowly disabling pieces of the UI until it went away the culprit was the right drawer. While it was closed it always had a spinning animation in the background chewing away at CPU — death by the smallest cut!</p><p>This phase was great because UI lockups were gone, the app was running at 60 FPS, and loading views with a lot of images was fast again. But better yet, since we were previously spending <strong>50ms</strong> per image load on init, the changes immensely helped TTI as well — shaving nearly <strong>2s</strong>. However, the additional FPS boost now made some degraded gesture interactions fairly obvious — so we kept going.</p><h1>Phase 4: Perceived Performance Optimizations</h1><p>Even when everything is running at 60 FPS things can still <em>feel</em> slow, and thats where perceived performance comes into play. To tackle this, we chose to focus in on one of the apps core experiences: navigation.</p><h3>Navigation drawers</h3><p>One of the primary interactions with Discord involves the left and right drawers. The component that powers them was created the week that React Native was released in 2015, and still suffered from the shortcomings of those times.</p><p>Drawers are a very gesture based interaction, and when that interaction requires logic to jump between the main thread and the JavaScript thread, it results in the drawers not perfectly following a swipe or finger drag. Due to the dependency between the threads, it also means that if the JavaScript thread is busy the interaction can briefly pause.</p><p>The other problem with the drawers was that they depended on <a href="https://facebook.github.io/react-native/docs/gesture-responder-system" target="_blank">React Native JS Responder system</a> which works well in most cases, but not when there are gestures <em>and</em> scroll views involved. This could create gesture conflicts, such as trying to open the drawer but instead having the chat view scroll. Our initial reaction was to just create very nice drawers using native <a href="https://developer.apple.com/documentation/uikit/uiview" target="_blank">UIViews</a> and then expose them to React Native to fill with content. However, we decided to browse around for better animation and gesture modules to see if there was a solution for this.</p><p>Luckily we found both from the same <a href="https://github.com/kmagiera" target="_blank">author</a> who has clearly been working to address this problem. <a href="https://github.com/kmagiera/react-native-gesture-handler" target="_blank">react-native-gesture-handler</a> which exposes <a href="https://developer.apple.com/documentation/uikit/touches_presses_and_gestures/using_responders_and_the_responder_chain_to_handle_events" target="_blank">UIKit&#x27;s responder system</a> to React Native and with it we also found references to <a href="https://github.com/kmagiera/react-native-reanimated" target="_blank">react-native-reanimated</a>. What makes them great together is that you can connect them to tie gestures to animations — all on the main thread - but you get to write all the code in JavaScript. react-native-reanimated basically exposes an animation logic graph not that different from the way you compose React components and is able to send it to the main thread, run it in a loop, and it can even reference values from other objects on the main thread.</p><p>Using this we were able to tie the <a href="https://kmagiera.github.io/react-native-gesture-handler/docs/handler-pan.html" target="_blank">&lt;PanGestureHandler&gt;</a> to an animation of how a drawer works and get a <strong>drawer that behaves buttery smooth </strong>like any other native app<strong>.</strong> Best of all it was done with a lot less code.</p><p>There is more to do with perceived performance and hopefully we as a team can continue to make it better. However, through this work we now had an app that uses way less CPU and battery while running at 60 FPS with buttery smooth interactions!</p><h1>Phase 5: RAM Bundles</h1><p>Finally, we decided to apply one final optimization with the hopes of tying everything together into a final TTI drop. This was actually something we had our eyes on for awhile — <a href="https://facebook.github.io/react-native/docs/performance#ram-bundles-inline-requires" target="_blank">RAM Bundles</a>.</p><p>The idea behind RAM bundles is simple: instead of loading one gigantic JavaScript blob, why not break it down into modules that can be lazily loaded as needed? Our build system already was using <a href="https://github.com/callstack/haul" target="_blank">Haul</a>, and conveniently a <a href="https://github.com/callstack/haul/tree/master/packages/haul-ram-bundle-webpack-plugin" target="_blank">plugin already existed</a> to enable them. We got it integrated, but unfortunately we learned that our codebase was not all that modular.</p><p>Despite this, with some minimal changes it still was able to defer loading some 100 of our 2600 modules, which did still yield a <em>800ms drop of TTI </em>on an iPhone 6.</p><p>Going beyond that, we rolled up our sleeves and further inspected the app entry point as a whole and were able to drastically speed up TTI by deferentially loading or omitting several key parts of the code base:</p><ul role="list"><li>Updated our modal, action sheet, and alert API’s to require dynamic imports — thus excluding them from initial load.</li><li>Stubbed out several key desktop-only features to avoid loading unused React code (such as the Game Store — <a href="https://blog.discordapp.com/whats-coming-for-nitro-a732ddc4b5b1" target="_blank">:c</a>) on iOS.</li><li>Always imported lodash since we found that importing submodules actually costs more because duplicate code is loaded.</li><li>Dynamically import many of our core native modules (such as the Discord media engine) to avoid loading this code until the point in time the feature is actually used.</li><li>Similarly, employed dynamic imports (inline require)for many of our common feature components to achieve lazy loading.</li><li>Dynamically imported our entire localization code and associated <a href="https://momentjs.com/" target="_blank">moment</a> locale code to be deferred until the app had loaded.</li></ul><p>After all this, we saw a <em>tremendous</em> speed up in the apps initial boot times in addition to the gains we had already achieved. On our benchmark iPhone 6 device, we saw <strong>average loading time decreases of 3500ms</strong>. On an iPhone XS the average time to load was <em>an additional 700ms</em> faster as well!</p><p>This final step tied everything together for us — now the app was launching quickly, interacting fluidly, and using much less CPU. Most importantly, the app just felt so much more usable on our iPhone 6 device. It was at this point that we felt our goals had been achieved.</p><h1>The Results</h1><p>Overall performance was greatly improved — the UI freezes and stutter that can be seen on the left have been all but eliminated:</p><figure style="padding-bottom:52.173913043478265%" class="w-richtext-align-center w-richtext-figure-type-video"><div><iframe allowfullscreen="true" frameborder="0" scrolling="no" src="https://player.vimeo.com/video/371265176"></iframe></div></figure><p>When we stepped back from the project we were extremely happy with the final outcome. The aftermath of our work can be directly observed by watching these <a href="https://vimeo.com/371488517" target="_blank">before and after</a> videos on an iPhone XS, and these <a href="https://vimeo.com/371265176" target="_blank">before and after</a> videos on an iPhone 6S. While we started by just trying to improve the FPS of the app, ultimately our exploration resulted in:</p><ul role="list"><li>Fluid gesture interactions for our core navigational system.</li><li>A fairly <strong>consistent 60 FPS</strong> across our supported devices and a <em>very</em> noticeable reduction in battery consumption.</li><li>A much better development experience since even the app under development mode runs much better than the <em>production app</em> before these changes.</li><li>An average of <strong>two seconds</strong> shaved off the initial load time. This was primarily achieved through our efforts enabling RAM bundles and optimizing our code paths to leverage it.</li></ul><p>Whats more, this investigation and mitigation was completed within a span of a few weeks. Although there are real pain points and challenges to using React Native, the overall gains significantly outweigh the costs which motivates us to keep investing in the platform.</p><p><em>We’re always looking for the next great addition to our engineering teams at Discord. If what’s described here sounds interesting to you, </em><a href="https://discordapp.com/jobs" target="_blank"><em>check out our available positions here.</em></a></p></div></div><div class="btn-wrapper w-condition-invisible"><a href="how-discord-achieves-native-ios-performance-with-react-native#" class="btn-blog w-dyn-bind-empty w-button"></a></div><div id="heading-2" class="rich-wrapper"><div class="blog-post-content w-dyn-bind-empty w-richtext"></div></div><div id="heading-3" class="rich-wrapper"><div class="blog-post-content w-dyn-bind-empty w-richtext"></div></div><div id="heading-4" class="rich-wrapper"><div class="blog-post-content w-dyn-bind-empty w-richtext"></div></div><div id="heading-5" class="rich-wrapper"><div class="blog-post-content w-dyn-bind-empty w-richtext"></div></div><div id="heading-6" class="rich-wrapper"><div class="blog-post-content w-dyn-bind-empty w-richtext"></div></div><div id="heading-7" class="rich-wrapper"><div class="blog-post-content w-dyn-bind-empty w-richtext"></div></div><div id="heading-8" class="rich-wrapper"><div class="blog-post-content w-dyn-bind-empty w-richtext"></div></div><div id="heading-9" class="rich-wrapper"><div class="blog-post-content w-dyn-bind-empty w-richtext"></div></div><div id="heading-10" class="rich-wrapper"><div class="blog-post-content w-dyn-bind-empty w-richtext"></div></div></div><div data-w-id="507df21e-7107-68af-2f54-b8d93479cf10" class="column-desctop w-condition-invisible w-col w-col-2 w-col-stack"><div class="rich-content-right"><div class="paragraph-medium bot-marg">Contents</div><a href="how-discord-achieves-native-ios-performance-with-react-native#heading-1" class="title-menu-anchor w-dyn-bind-empty"></a><a href="how-discord-achieves-native-ios-performance-with-react-native#heading-2" class="title-menu-anchor w-dyn-bind-empty"></a><a href="how-discord-achieves-native-ios-performance-with-react-native#heading-3" class="title-menu-anchor w-dyn-bind-empty"></a><a href="how-discord-achieves-native-ios-performance-with-react-native#heading-4" class="title-menu-anchor w-dyn-bind-empty"></a><a href="how-discord-achieves-native-ios-performance-with-react-native#heading-5" class="title-menu-anchor w-dyn-bind-empty"></a><a href="how-discord-achieves-native-ios-performance-with-react-native#heading-6" class="title-menu-anchor w-dyn-bind-empty"></a><a href="how-discord-achieves-native-ios-performance-with-react-native#heading-7" class="title-menu-anchor w-dyn-bind-empty"></a><a href="how-discord-achieves-native-ios-performance-with-react-native#heading-8" class="title-menu-anchor w-dyn-bind-empty"></a><a href="how-discord-achieves-native-ios-performance-with-react-native#heading-9" class="title-menu-anchor w-dyn-bind-empty"></a><a href="how-discord-achieves-native-ios-performance-with-react-native#heading-10" class="title-menu-anchor w-dyn-bind-empty"></a></div></div></div><div class="divider-bar"></div><div class="w-row"><div class="w-col w-col-3 w-col-medium-6"><div class="author-title">THE AUTHOR</div></div><div class="w-col w-col-9 w-col-medium-6"><div class="the-author-section footer"><img src="https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/6126ba0b348c620c22bebbd6_1_DPozN5ReL1X-5eV6A5IsPQ.jpg" loading="lazy" width="47" alt="" class="blog-post-author-image-footer"/><div><div class="blog-post-author-footer">Miguel Gaeta</div><div class="blog-post-author-desc">Senior Software Engineer at Discord</div></div></div></div></div><div class="divider-bar"></div><div><div class="author-title">MORE FROM</div><div class="category-title-footer">Engineering &amp; Design</div><div class="footer-more-from w-dyn-list"><div role="list" class="featured-small-list w-dyn-items w-row"><div role="listitem" class="collection-item-small w-dyn-item w-col w-col-4"><a href="how-data-science-informs-strategy-innovation-at-discord" class="link-block-4 w-inline-block"><img src="https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/61fc38b519cf1b6213676d5d_202201002_COM_DataScienceBlog_1800x720.png" loading="lazy" alt="" sizes="(max-width: 479px) 83vw, (max-width: 767px) 90vw, (max-width: 991px) 29vw, (max-width: 1919px) 30vw, 434.6640625px" srcset="https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/61fc38b519cf1b6213676d5d_202201002_COM_DataScienceBlog_1800x720-p-500.png 500w, https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/61fc38b519cf1b6213676d5d_202201002_COM_DataScienceBlog_1800x720-p-800.png 800w, https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/61fc38b519cf1b6213676d5d_202201002_COM_DataScienceBlog_1800x720-p-1080.png 1080w, https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/61fc38b519cf1b6213676d5d_202201002_COM_DataScienceBlog_1800x720-p-1600.png 1600w, https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/61fc38b519cf1b6213676d5d_202201002_COM_DataScienceBlog_1800x720.png 1800w" class="blog-featured-small-image"/></a><a href="../category/engineering" class="blog-hero-category">Engineering &amp; Design</a><a href="how-data-science-informs-strategy-innovation-at-discord" class="link-block-20 w-inline-block"><div class="blog-featured-title-small">How Data Science Informs Strategy &amp; Innovation at Discord</div></a></div><div role="listitem" class="collection-item-small w-dyn-item w-col w-col-4"><a href="why-and-how-discord-uses-patch-to-test-elixir" class="link-block-4 w-inline-block"><img src="https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/61aa7642a72a1b627d695f49_Discord-Elixir-Blog-Header.png" loading="lazy" alt="" sizes="(max-width: 479px) 83vw, (max-width: 767px) 90vw, (max-width: 991px) 29vw, (max-width: 1919px) 30vw, 434.6640625px" srcset="https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/61aa7642a72a1b627d695f49_Discord-Elixir-Blog-Header-p-500.png 500w, https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/61aa7642a72a1b627d695f49_Discord-Elixir-Blog-Header-p-800.png 800w, https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/61aa7642a72a1b627d695f49_Discord-Elixir-Blog-Header.png 1800w" class="blog-featured-small-image"/></a><a href="../category/engineering" class="blog-hero-category">Engineering &amp; Design</a><a href="why-and-how-discord-uses-patch-to-test-elixir" class="link-block-20 w-inline-block"><div class="blog-featured-title-small">Why and How Discord Uses Patch to Test Elixir</div></a></div><div role="listitem" class="collection-item-small w-dyn-item w-col w-col-4"><a href="how-discord-creates-insights-from-trillions-of-data-points" class="link-block-4 w-inline-block"><img src="https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/619575c462b70073305c7cbb_Engineering-Blog-Header-Updated.png" loading="lazy" alt="" sizes="(max-width: 479px) 83vw, (max-width: 767px) 90vw, (max-width: 991px) 29vw, (max-width: 1919px) 30vw, 434.6640625px" srcset="https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/619575c462b70073305c7cbb_Engineering-Blog-Header-Updated-p-500.png 500w, https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/619575c462b70073305c7cbb_Engineering-Blog-Header-Updated-p-1080.png 1080w, https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/619575c462b70073305c7cbb_Engineering-Blog-Header-Updated-p-1600.png 1600w, https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/619575c462b70073305c7cbb_Engineering-Blog-Header-Updated-p-2000.png 2000w, https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/619575c462b70073305c7cbb_Engineering-Blog-Header-Updated.png 2500w" class="blog-featured-small-image"/></a><a href="../category/engineering" class="blog-hero-category">Engineering &amp; Design</a><a href="how-discord-creates-insights-from-trillions-of-data-points" class="link-block-20 w-inline-block"><div class="blog-featured-title-small">How Discord Creates Insights from Trillions of Data Points</div></a></div></div></div></div></div><div class="section footer wf-section"><div class="w-layout-grid grid-f"><div id="w-node-_2c491f7c-a0f7-123b-2ff5-89166f6e8926-6f6e8924" class="footer-title"><h2 class="footer-title-text">Imagine a place</h2><div class="language"><div class="lang-container"><div id="locale-dropdown" class="lang-dropdown-container"><div class="lang-dropdown"></div></div><div class="lang-selector-container"><div class="locale-container"><img src="https://assets-global.website-files.com/plugins/Basic/assets/placeholder.60f9b1840c.svg" loading="lazy" alt="" class="flag"/><div class="selector-language-name"></div></div><img src="https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/631e41a9c664e8212a6ae94b_arrow.svg" loading="lazy" alt="" class="arrow-icon"/></div></div></div><div class="div-block-24"></div><div><a href="https://twitter.com/discord" class="w-inline-block"><img src="https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/5f8ff4ffa222a56c0ac1f753_twitter.svg" loading="lazy" alt="" class="image-3"/></a><a href="https://www.instagram.com/discord/" class="w-inline-block"><img src="https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/5f8ff4ff67595747f2e29eee_instagram.svg" loading="lazy" alt="" class="image-3"/></a><a href="https://www.facebook.com/discord/" class="link-block-23 w-inline-block"><img src="https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/5f8ff4ff12dd361cb2329600_facebook.svg" loading="lazy" alt="" class="image-3"/></a><a href="https://www.youtube.com/discord/" class="w-inline-block"><img src="https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/5f8ff4ff82203334500c932f_youtube.svg" loading="lazy" alt="" class="image-3"/></a><a href="https://www.tiktok.com/@discord" class="w-inline-block"><img src="https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/6374a1bf7602dc14503d942a_Tiktok%20(1).svg" loading="lazy" alt="" class="image-3"/></a></div></div><div id="w-node-_2c491f7c-a0f7-123b-2ff5-89166f6e8929-6f6e8924" class="footer-link-group"><div class="footer-link"><div class="footer-link-caption">Product</div><a href="https://discord.com/download" class="footer-link-item">Download</a><a href="https://discord.com/nitro" class="footer-link-item">Nitro</a><a href="https://discordstatus.com/" class="footer-link-item">Status</a></div><div class="footer-link"><div class="footer-link-caption">Company</div><a href="https://discord.com/company" class="footer-link-item">About</a><a href="../jobs" class="footer-link-item">Jobs</a><a href="https://discord.com/branding" class="footer-link-item">Branding</a><a href="https://discord.com/newsroom" class="footer-link-item">Newsroom</a></div></div><div id="w-node-_2c491f7c-a0f7-123b-2ff5-89166f6e8946-6f6e8924" class="footer-link-group"><div class="footer-link"><div class="footer-link-caption">Resources</div><a href="https://discord.com/college" class="footer-link-item">College</a><a href="https://support.discord.com/hc/en-us" class="footer-link-item">Support</a><a href="https://discord.com/safetycenter" class="footer-link-item">Safety</a><a href="discord-activities-play-games-and-watch-together" class="footer-link-item">Blog</a><a href="https://feedback.discord.com/" class="footer-link-item">Feedback</a><a href="../build" class="footer-link-item">Developers</a><a href="../brand-new/streamkit" class="footer-link-item">StreamKit</a></div><div class="footer-link"><div class="footer-link-caption">Policies</div><a href="../terms" class="footer-link-item">Terms</a><a href="https://discord.com/privacy" class="footer-link-item">Privacy</a><a href="https://discord.com/guidelines" class="footer-link-item">Guidelines</a><a data-open-cookie-settings="true" href="how-discord-achieves-native-ios-performance-with-react-native#" class="footer-link-item">Cookie Settings</a><a href="https://discord.com/acknowledgements" class="footer-link-item">Acknowledgements</a><a href="https://discord.com/licenses" class="footer-link-item">Licenses</a><a href="../moderation" class="footer-link-item">Moderation</a></div></div></div><div class="footer-divider"></div><div class="footer-bar"><a href="https://discord.com" class="w-inline-block"><img src="https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/60ae8db338d6025407c54d24_Logo.svg" loading="lazy" alt="Discord" class="logo-2"/></a><a href="how-discord-achieves-native-ios-performance-with-react-native#" class="button mobile footer-open-discord-button footer-open-discord-button-js w-button">Download</a><a href="how-discord-achieves-native-ios-performance-with-react-native#" class="button desktop footer-open-discord-button footer-open-discord-button-js w-button">Open Discord</a></div></div><script src="https://d3e54v103j8qbb.cloudfront.net/js/jquery-3.5.1.min.dc5e7f18c8.js?site=5f8dd67f8fdd6f51f0b50904" type="text/javascript" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script><script src="https://assets-global.website-files.com/5f8dd67f8fdd6f51f0b50904/js/discordpages.6a1e691d1.js" type="text/javascript"></script><!--[if lte IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/placeholders/3.0.2/placeholders.min.js"></script><![endif]--><script type="text/javascript" src="../w/loader/loader.js" async defer></script>
<script src="../webflow-scripts/bodyEnd.js" defer async></script>
<script>
  function initDownloadButton() {
    let userAgent = window.navigator.userAgent,
        platform = window.navigator.platform,
        macosPlatforms = ['Macintosh', 'MacIntel', 'MacPPC', 'Mac68K'],
        windowsPlatforms = ['Win32', 'Win64', 'Windows', 'WinCE'],
        iosPlatforms = ['iPhone', 'iPad', 'iPod'],
        buttonAttributes = null;

    if (iosPlatforms.indexOf(platform) !== -1) {
      buttonAttributes = {
        text: "Download on the App Store",
        href: "https://itunes.apple.com/us/app/discord-chat-for-games/id985746746",
      }
    } else if (macosPlatforms.indexOf(platform) !== -1) {
      buttonAttributes = {
        text: "Download for Mac",
        href: "https://discord.com/api/download?platform=osx",
      }
    } else if (windowsPlatforms.indexOf(platform) !== -1) {
      buttonAttributes = {
        text: "Download for Windows",
        href: "https://discord.com/api/download?platform=win",
      }
    } else if (/Android/.test(userAgent)) {
      buttonAttributes = {
        text: "Download on Google Play",
        href: "https://play.google.com/store/apps/details?id=com.discord",
      }
    } else if (!os && /Linux/.test(platform)) {
      buttonAttributes = {
        text: "Download for Linux",
        href: "https://discord.com/api/download?platform=linux",
      }
    }

	let downloadEl = document.querySelectorAll(".download-button");
    if (downloadEl) {
      downloadEl.forEach(function(el) {
        el.innerText = buttonAttributes.text;
        el.href = buttonAttributes.href;
      });
    }

	let downloadSidebarEl = document.querySelectorAll(".download-sidebar");
    if (downloadSidebarEl) {
      downloadSidebarEl.forEach(function(el) {
        el.href = buttonAttributes.href;
      });
    }
  }
  
  function initLogInOrOpenDiscordButton() {
    let loginButtonText, loginRoute, signUpButtonText, signupRoute;
    let loginIsOpenDiscordButton = true;
    const loginLink = 'https://discord.com/login';
    const signupLink = 'https://discord.com/register';
    const openLink = 'https://discord.com/channels/@me';
    
    if(window.localStorage.getItem("token") != null) {
      loginButtonText = "Open Discord";
      loginRoute = openLink;
      loginIsOpenDiscordButton = true;
      
      signUpButtonText = "Open Discord";
      signupRoute = openLink;
    } else {
      loginIsOpenDiscordButton = false;
      loginButtonText = "Login";
      signUpButtonText = "Sign up";
      loginRoute = loginLink;
      signupRoute = signupLink;
    }
    
    let loginEl = document.querySelectorAll(".login-button-js");
    let footerEl = document.querySelectorAll(".footer-open-discord-button-js");
    if (loginEl && loginEl.length > 0) {
      loginEl.forEach(function(el) {
        if (!loginIsOpenDiscordButton) {
        	el.classList.add('hide-on-mobile');
        }
        el.innerText = loginButtonText;
      	el.href = loginRoute;
        if (loginIsOpenDiscordButton) {
            el.dataset.trackNav = 'navbar-open-button';
        }
      });
    }
    if (footerEl && footerEl.length > 0) {
      footerEl.forEach(function(el) {
        if (window.innerWidth <= 768) {
        	el.innerText = "Download";
        } else {
        	el.innerText = signUpButtonText;
        }
        el.href = signupRoute;
      });
    }
  }
  
  function initSignUpOrOpenButtons() {
    const signupLink = 'https://discord.com/register';
    const openLink = 'https://discord.com/channels/@me';
    const isLoggedIn = window.localStorage.getItem("token") != null;
    const buttonEl = document.querySelectorAll(".open-or-signup-js");
    
    if (buttonEl && buttonEl.length > 0) {
        buttonEl.forEach(function(el) {
            if (isLoggedIn) {
                el.innerText = 'Open Discord';
                el.href = openLink;
            } else {
                el.innerText = 'Sign up';
                el.href = signupLink;
            }
        });
    }
  }
  
  initSignUpOrOpenButtons();
  initLogInOrOpenDiscordButton();
  initDownloadButton();
</script>


<!-- build:inlineScriptNonceTag -->
  <script>
  <!-- endbuild -->
  </script>
  <!-- section:dataLayer -->
  <script src="https://discord.com/assets/oneTrust/v4/scripttemplates/otSDKStub.js" type="text/javascript" charset="UTF-8" data-domain-script="04da1d72-0626-4fff-b3c6-150c719cc115"></script>
  <!-- build:inlineScriptNonceTag -->
  <script>
    <!-- endbuild -->
    window.dataLayer = window.dataLayer || [];
    window.dataLayer.push({ 'allCookiesOK': false });
  </script>
  <!-- endsection -->
  <!-- section:gtm -->
  <!-- build:inlineScriptNonceTag -->
  <script>
  <!-- endbuild -->
    (function (w, d, s, l, i) {
      w[l] = w[l] || []; w[l].push({
        'gtm.start':
          new Date().getTime(), event: 'gtm.js'
      }); var f = d.getElementsByTagName(s)[0],
        j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src =
          'https://www.googletagmanager.com/gtm.js?id=' + i + dl + '&gtm_auth=GI0g9O-54_SitcgmxQKxlA&gtm_preview=env-2&gtm_cookies_win=x'; f.parentNode.insertBefore(j, f);
    })(window, document, 'script', 'dataLayer', 'GTM-N7BVC2W');
    !function (b, e, f, g, a, c, d) { b.fbq || (a = b.fbq = function () { a.callMethod ? a.callMethod.apply(a, arguments) : a.queue.push(arguments) }, b._fbq || (b._fbq = a), a.push = a, a.loaded = !0, a.version = "2.0", a.queue = [], c = e.createElement(f), c.async = !0, c.src = g, d = e.getElementsByTagName(f)[0], d.parentNode.insertBefore(c, d)) }(window, document, "script", "https://connect.facebook.net/en_US/fbevents.js");
    fbq("init", "550821025425262");
  </script>
  <!-- endsection --><script type="application/ld+json">
{ 
 "@context": "http://schema.org", 
 "@type": "BlogPosting",
 "headline": "How Discord achieves native iOS performance with React Native",
 "image": "https://assets-global.website-files.com/5f9072399b2640f14d6a2bf4/611ed88188db6c4aeb477a51_1_Xrs64ioQm2DcmH9Si-M3pw.png",
 "publisher": "Discord",
 "url": "https://discord.com/blog/how-discord-achieves-native-ios-performance-with-react-native",
 "datePublished": "Aug 25, 2021",
 "dateCreated": "Aug 19, 2021",
 "dateModified": "Aug 25, 2021",
 "description": "",
   "author": {
    "@type": "Person",
    "name": "Miguel Gaeta"
  }
 }
</script><script nonce="NiwxNzMsMTQ3LDExNSw2OCwyNDAsNDcsMTE4">(function(){var js = "window['__CF$cv$params']={r:'76fbee384886089d',m:'CXWpGlpfCuJZ7M8GArNRlNwJRvGSL.E2xs5dR4SxZVo-1669395521-0-AU+Ahl2KpKE6iQ9wYg7ghmGVY8isPcvGhP5s8HB+KqCFRytff/yL6Y5O0+RM53zh8d0LrVyGGURPgrJJHKpS+977Ix45btZBJFb6w/hPS18kkKyj+9bMHOLX2yBE0qVwEX3Bs/zIwAQbcAsYrMj8LkqRqZMSIlaAAE0e+YqcuJqoaqcE613kxGrm3psMhhUDXCDpXmmjjnlqIMlVU3JgrAY=',s:[0xea9f8761bc,0x77464375a9],u:'/cdn-cgi/challenge-platform/h/b'};var now=Date.now()/1000,offset=14400,ts=''+(Math.floor(now)-Math.floor(now%offset)),_cpo=document.createElement('script');_cpo.nonce='NiwxNzMsMTQ3LDExNSw2OCwyNDAsNDcsMTE4',_cpo.src='/cdn-cgi/challenge-platform/h/b/scripts/alpha/invisible.js?ts='+ts,document.getElementsByTagName('head')[0].appendChild(_cpo);";var _0xh = document.createElement('iframe');_0xh.height = 1;_0xh.width = 1;_0xh.style.position = 'absolute';_0xh.style.top = 0;_0xh.style.left = 0;_0xh.style.border = 'none';_0xh.style.visibility = 'hidden';document.body.appendChild(_0xh);function handler() {var _0xi = _0xh.contentDocument || _0xh.contentWindow.document;if (_0xi) {var _0xj = _0xi.createElement('script');_0xj.nonce = 'NiwxNzMsMTQ3LDExNSw2OCwyNDAsNDcsMTE4';_0xj.innerHTML = js;_0xi.getElementsByTagName('head')[0].appendChild(_0xj);}}if (document.readyState !== 'loading') {handler();} else if (window.addEventListener) {document.addEventListener('DOMContentLoaded', handler);} else {var prev = document.onreadystatechange || function () {};document.onreadystatechange = function (e) {prev(e);if (document.readyState !== 'loading') {document.onreadystatechange = prev;handler();}};}})();</script></body></html>